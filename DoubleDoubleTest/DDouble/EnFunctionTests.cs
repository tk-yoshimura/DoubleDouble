using DoubleDouble;
using Microsoft.VisualStudio.TestTools.UnitTesting;
using PrecisionTestTools;
using System;

namespace DoubleDoubleTest.DDouble {
    [TestClass]
    public class EnFunctionTests {
        [TestMethod]
        public void EnTest() {
            ddouble[] n0_expecteds = {
                "inf",
                "3.115203132285619472980681067913282589187",
                "1.213061319425266847207599069982360906884",
                "0.6298220703213529428507287345910238839603",
                "0.3678794411714423215955237701614608674458",
                "0.2292038374881520802599083413182700822345",
                "0.1487534400989532192888536471760083475614",
                "0.09929939625739721524612414780935486629413",
                "0.06766764161830634594699974748624220170382",
                "0.04684409980527303857031897299586582100822",
                "0.03283399944955951806781146978686392313512",
                "0.02324649498425729916452000929380063611223",
                "0.01659568945595464765978080521668725887723",
                "0.01193052548668369534981533392849112100312",
                "0.008627823834948143068510369246748527163332",
                "0.006271398894935762196306982693448783858685",
                "0.004578909722183545073429505318310310552978",
                "0.003356290331529236534891046083765069176459",
                "0.002468665897387179221365140952651228393675",
                "0.001821409516446449300436106096263240178561",
                "0.001347589399817093419327209684629684849770",
                "0.0009995273141297874812368627316912584393009",
                "0.0007430493524480121806299459426765033469801",
                "0.0005535270950451594900845944356142350166852",
                "0.0004131253627777264038408612384694446485844",
                "0.0003088726617964334787541619161041171429737",
                "0.0002312983373811649919050620511027159738462",
                "0.0001734636475246184297704029765628553216847",
                "0.0001302688522220737440004480120584689466391",
                "0.00009795508811621366394270349939000612533466",
                "0.00007374458268637781108026667847071429304151",
                "0.00005557968265492742410998739070858806834687",
                "0.00004193282848781397985267364072260762741386"
            };

            ddouble[] n1_expecteds = {
                "inf",
                "1.044282634443738194536438161232282251892",
                "0.5597735947761608117467959393150852352268",
                "0.3403408129112300078065357686796446251898",
                "0.2193839343955202736771637754601216490310",
                "0.1464133725259101766932585022903932235748",
                "0.1000195824066326519019093399116669782617",
                "0.06948868460463879263837412067261358609691",
                "0.04890051070806111956723983522804952231449",
                "0.03476207311944459707617859810088544864118",
                "0.02491491787026973549562801227460963594585",
                "0.01797893821545440659344439154546103850433",
                "0.01304838109419703741250074582864502294848",
                "0.009516507415488778197975644280843255256116",
                "0.006970139857548392919272924566140513707547",
                "0.005124102198586809787413117875176032515654",
                "0.003779352409848906478874860132466414851717",
                "0.002795652712273958452670962693078440365877",
                "0.002073400754714614432885593869579788488932",
                "0.001541364705263895250505442242605119387266",
                "0.001148295591275325797330561969819722076266",
                "0.0008571271048688706040127308655077983751080",
                "0.0006409260498657626429986929674782124165925",
                "0.0004800413909395483183540698967182010219120",
                "0.0003600824521626586592953941157717971888274",
                "0.0002704758872637179088496193713105027323534",
                "0.0002034298668393981973738333159213098314210",
                "0.0001531867941750292902008821444608012417407",
                "0.0001154817316103382164310114560437894989082",
                "0.00008714830861656069907788037889497885567946",
                "0.00006583089326708023061690495987794036434977",
                "0.00004977367266401179565252914715266525798136",
                "0.00003766562284392490177255799595075272089049"
            };

            ddouble[] n2_expecteds = {
                "1.000000000000000000000000000000000000000",
                "0.5177301244604703196110607266702500843239",
                "0.3266438623245530177304015653336378358285",
                "0.2171109430575922012831447244335344440778",
                "0.1484955067759220479183599947013392184148",
                "0.1034880812028023794583122987848460733247",
                "0.07310078653848085108041646089651205394958",
                "0.05216874539232723956356254748929724034514",
                "0.03753426182049045275951982451638535877865",
                "0.02718456004311399336181584351370583782583",
                "0.01979770394822445643045864378063571797318",
                "0.01448578111420795457045794880793389342173",
                "0.01064192508527283074184017816412670778627",
                "0.007845558731383480743478991354855563677767",
                "0.005801893920899125522331056382128047095245",
                "0.004302362611308571533351993068522817536364",
                "0.003198229249338554378218580743375582805046",
                "0.002382709881834931849435354410418172444973",
                "0.001778693142026541548157961873821479571345",
                "0.001330212853117131737170653304876073758654",
                "0.0009964690427088381099832385740498138675191",
                "0.0007476010986198136054266922974631653370128",
                "0.0005616781642023724569718913635906001171317",
                "0.0004225427986072642374505160986521954699456",
                "0.0003182574636904064672728027361858847585421",
                "0.0002399798408294723119033909049600900663767",
                "0.0001811450585214841644529867786791399257639",
                "0.0001368687601097266920942656166888650396223",
                "0.0001035098442821486929860558921027561341164",
                "0.00007834915137248399526996762358894770500021",
                "0.00005935267064473185347521288944580446518804",
                "0.00004499657742959612054530138755840178033273",
                "0.00003413764515111262464092515817483925218700"
            };

            ddouble[] n3_expecteds = {
                "0.5000000000000000000000000000000000000000",
                "0.3246841259781436441712025426553790631079",
                "0.2216043642751784573692993761621807677638",
                "0.1547666727239102780878440038090585399559",
                "0.1096919671977601368385818877300608245155",
                "0.07857234767834356300099752658339000556865",
                "0.05673949017035427615632788970962222020890",
                "0.04123931950693622872224140028005042270537",
                "0.03013337979781589318747992296985684292517",
                "0.02211698223242892585956602066742998108019",
                "0.01629536937666882704669103250778525645242",
                "0.01204598157131784881683533316806677119944",
                "0.008930646556022725376910940578840826636450",
                "0.006638070977362848735296556682157780653701",
                "0.004945377349585780705813797513085840119152",
                "0.003691943031800982493040605546736186854351",
                "0.002761360945689981390421849149869455495864",
                "0.002068858455600397456593344805862155554408",
                "0.001552438699561434764716152927366934850243",
                "0.001166592075407129212755450379544520247279",
                "0.0008778008927706382733599277764496774556270",
                "0.0006613063157136814240016973898487443935063",
                "0.0004987707676755092400596500924862338820832",
                "0.0003765798522589488513229752187658636968764",
                "0.0002846036972619598097041755068506796701268",
                "0.0002152900655217536464086594098250846143654",
                "0.0001629981562939626892192446353766221562674",
                "0.0001235077450252596146569635895747172019605",
                "0.00009365652778973767855037241984499484382930",
                "0.00007107152069602004893866754977883677371239",
                "0.00005396967015617234101895170884341185445051",
                "0.00004100953274815880131315826220697186605478",
                "0.00003118073334680542084699393019107350090746"
            };

            ddouble[] n4_expecteds = {
                "0.3333333333333333333333333333333333333333",
                "0.2325432505256229857341232104381586271733",
                "0.1652428258583480649730499489700300231867",
                "0.1187638493993606661907211826954913360011",
                "0.08606249132456072825231396081046668097676",
                "0.06276312075408688219121283947286669861078",
                "0.04600697496429947156626287873319306367627",
                "0.03386837810443557547226493605876092542678",
                "0.02502284121366030183967988301092357251910",
                "0.01854533817963308453306471424632687994602",
                "0.01378219172740890918426703106589888890225",
                "0.01026713729519449615204428644858937617005",
                "0.007665042899931922282869864637846432240783",
                "0.005733492385097583832395342016861118711872",
                "0.004296187566256089423146000355939801551543",
                "0.003224319828918474629082971433390746255418",
                "0.002423398368658084910676874891254473409485",
                "0.001823861824232522027588410143695794297905",
                "0.001374340796738616684973482037926440315149",
                "0.001036794281645590138827704884804639891197",
                "0.0007829808450774252432788031803000123235715",
                "0.0005918867472281856001615393482243995801406",
                "0.0004478440720829220577122090586821606856443",
                "0.0003391488820069037242931034989593783629668",
                "0.0002570433310315331882733714632375299569152",
                "0.0001949637422389163173864635547479844346006",
                "0.0001479837256889383224859377340732032714208",
                "0.0001124007806235573340052386207233107693795",
                "0.00008542875700878415271684304849810623988954",
                "0.00006496862126546790292642021156032593308717",
                "0.00004943728132551367515328742406825609647751",
                "0.00003763955392581894222514191529584185592123",
                "0.00002867225370935615734847922808409100401707"
            };

            ddouble[] n8_expecteds = {
                "0.1428571428571428571428571428571428571429",
                "0.1068399164985908167606875790507389195214",
                "0.08007073163363616380491915364756876149026",
                "0.06011858424554789074020063937404587835810",
                "0.04521148206188466649118007415171540003321",
                "0.03405031104286335868502648609588250348602",
                "0.02567825223208377198398708433380415147406",
                "0.01938791025649656332192197221142483613597",
                "0.01465460760028628775727004010208738650021",
                "0.01108810694145589773848379344675156906383",
                "0.008397456702528425454275915996241053684369",
                "0.006365263168428148036971710774871453675262",
                "0.004828781181282259250579863947047409046537",
                "0.003665965475093704553084197869391783329446",
                "0.002785148560998726515573038496811166994018",
                "0.002117380928527859479121666423748063789987",
                "0.001610732783245043986764286694155708192029",
                "0.001226045595459238562216066448436814011026",
                "0.0009337582490002319595152181811070894895122",
                "0.0007115316836792616441608500673187280670326",
                "0.0005424682061642421923405616018711495011761",
                "0.0004137745761707657645464962698193894291750",
                "0.0003157568768746577327874576717718422380483",
                "0.0002410638604507307028734847833499971542864",
                "0.0001841166670201061970750444777821889713972",
                "0.0001406785363308303603945778054894764201609",
                "0.0001075298126780698214927452721990029054723",
                "0.00008222224142033162833217035443989162196720",
                "0.00006289304444105540944835289684238438494486",
                "0.00004812411158764292314954533051899846532768",
                "0.00003683527555561710550408597634600210238981",
                "0.00002820335950508710768972399086743677452753",
                "0.00002160073015997537643838063928726415564036"
            };

            ddouble[] n16_expecteds = {
                "0.06666666666666666666666666666666666666667",
                "0.05101037488852874421328084673526743738540",
                "0.03904458571131033626990480426653280245756",
                "0.02989571138677433379924684267319318310591",
                "0.02289794293742573335219114782106220200194",
                "0.01754355993098797371193330082587398438617",
                "0.01344519897182213943690722015262977336062",
                "0.01030718157843480589972620992483959670456",
                "0.007903711172168774948008620887716188922272",
                "0.006062282750069677886545794636053900856451",
                "0.004651051291872181668600329018381038275512",
                "0.003569208757918590724971871441799728820650",
                "0.002739649118953688512149916958351580499148",
                "0.002103374532710920401755085594417387586556",
                "0.001615227287171276338935766013847568984578",
                "0.001240631793440308309955332471171255459632",
                "0.0009531065047034384036457223387842501092447",
                "0.0007323630189057937443498270135953342738878",
                "0.0005628532109187815415384270970840756074529",
                "0.0004326583729957636169243077354662608482395",
                "0.0003326395441400128137076675469020685401670",
                "0.0002557873897059473760964589786750737525479",
                "0.0001967245989994163889960988919133200692256",
                "0.0001513248977228582353704905723013294446939",
                "0.0001164212560337977024070077382584390913281",
                "0.00008958234360419789103793779860572477705262",
                "0.00006894122044777035587168949361255592042617",
                "0.00005306402139715643313642083343433251072108",
                "0.00004084927060915850826535315661217569721206",
                "0.00003145066168938906346719355241391289207103",
                "0.00002421781990807651580346267981393069559890",
                "0.00001865084816791947609093031911626426719738",
                "0.00001436544138027544197338066536733681107256"
            };

            ddouble[] n32_expecteds = {
                "0.03225806451612903225806451612903225806452",
                "0.02491503967485713285542253853699815198673",
                "0.01924493709753823717204079512730196923777",
                "0.01486628511604138573664664093215310266687",
                "0.01148467999743254748249263019022623041760",
                "0.008872893437211200877898826243075442815230",
                "0.006855529770529122418944646361769941088233",
                "0.005297191125405160803094149346770587123357",
                "0.004093347574504835233451762456622470415622",
                "0.003163293349425092295212933663185443438891",
                "0.002444711966681104899946285585220513522235",
                "0.001889482379257993270773713254538767707042",
                "0.001460442480746477224914357554175714113119",
                "0.001128891201896427688275596635288142408529",
                "0.0008726604808913173597827004083427121224104",
                "0.0006746269700146416572283435605991844303597",
                "0.0005215630903580322050452565385076892425381",
                "0.0004032499872183525948731006398668849999838",
                "0.0003117926316615434979877732999644291911829",
                "0.0002410909603832430693559493055144408706158",
                "0.0001864314728301449170808692522322132375151",
                "0.0001441718255801959010941906966360364351880",
                "0.0001114972296268108147160717357984750917650",
                "0.00008623229081386046893365615611112442971743",
                "0.00006669566440650394449687020204146495514233",
                "0.00005158777395365777798929258349630429181017",
                "0.00003990406677055947486327446008076375473984",
                "0.00003086799361101969535985296097721544130855",
                "0.00002387922416252431021932616905628196587287",
                "0.00001847363217892138406960613140339296600997",
                "0.00001429237325644738340339962427088193274497",
                "0.00001105798761391731109843595360980087700725",
                "8.555930773285816484698532042012214290223e-6"
            };

            ddouble[] n64_expecteds = {
                "0.01587301587301587301587301587301587301587",
                "0.01231227419239900009870189830575765691251",
                "0.009550461037614853512201603746824801152791",
                "0.007408283008144714904011295497125837807985",
                "0.005746691726372963707210424404693586256901",
                "0.004457848294789533802399343150912924978812",
                "0.003458116805883733368420696057701430303403",
                "0.002682631148770757906504750979589697673906",
                "0.002081081750570439683360611775385642688205",
                "0.001614448274212174949707232652082660743052",
                "0.001252465839934405862000918176696153806711",
                "0.0009716600546201729246082123532235162976350",
                "0.0007538231292165604637734579871776035839950",
                "0.0005848320490998540548986219699056891074883",
                "0.0004537320030718473203953209598613753074026",
                "0.0003520255216053907112461704769519147137048",
                "0.0002731211464791114427433859085923331680173",
                "0.0002119058222707303618351611899168001531019",
                "0.0001644132399790383327102355864090093775787",
                "0.0001275665973809147883147695772438017573150",
                "0.00009897907514061093897593622593078009013011",
                "0.00007679907660000470901793816277743693563788",
                "0.00005959018637944357322675126044704989004910",
                "0.00004623805743342455768759862443211690697181",
                "0.00003587818459873084909185451549078169644694",
                "0.00002783987859009727773570600624071152916876",
                "0.00002160280596145205166169956659480213923322",
                "0.00001676327609063283012495421665530770049460",
                "0.00001300808874890369253761044103668096107733",
                "0.00001009424637227836731713990596519311686616",
                "7.833215622506812829918680231570715965387e-6",
                "6.078717920728495713887922607177815258605e-6",
                "4.717257518073088961152872607751981908887e-6"
            };

            ddouble[] n128_expecteds = {
                "0.007874015748031496062992125984251968503937",
                "0.006120146674673896649563218691045458577658",
                "0.004756955754510756178536718227903766402634",
                "0.003697414298304233920315492918486374257087",
                "0.002873881367278722394640067277968407948198",
                "0.002233784463162307261006986372550917707934",
                "0.001736262547298532208868580281940218513342",
                "0.001349556973688966586345785073643957377858",
                "0.001048983696875273551078522059894926273420",
                "0.0008153572455732808951605563435716045576702",
                "0.0006337658093420053194854800827229843791264",
                "0.0004926192120110990744742078287576469697662",
                "0.0003829089749292018952632230601442165363878",
                "0.0002976332188564864398529920796181595563441",
                "0.0002313496808863934729592204781453268495890",
                "0.0001798283046800810233798357283402740819960",
                "0.0001397812212011964273854260995956252768180",
                "0.0001086528792478495799264344607250329299485",
                "0.00008445692607849856368715367339242042078330",
                "0.00006564942366054588391666592504400185561268",
                "0.00005103030620821165385213831359062900421569",
                "0.00003966678790697475317590676485450631403282",
                "0.00003083383121401696870334003461577862926861",
                "0.00002396787538490179648134440823036193606702",
                "0.00001863087147017684635252694587929687363185",
                "0.00001448232801630098732435308894018633186703",
                "0.00001125758311201989515543517108723058964557",
                "8.750915900971936895493389296214929761502e-6",
                "6.802419614932038464272729449517243800746e-6",
                "5.287798295970405359516593916588137875246e-6",
                "4.110436001350255277690343388882833339044e-6",
                "3.195232337989869643666611093766537228598e-6",
                "2.483810914893040929350550429582517718894e-6"
            };

            ddouble[] n255_expecteds = {
                "0.003937007874015748031496062992125984251969",
                "0.003063118030625571524989281650593566492186",
                "0.002383206126452918373759960927575142459911",
                "0.001854214219560616182476448974293830439336",
                "0.001442642202566605495608730797680137744694",
                "0.001122426165543698131326890195708467242755",
                "0.0008732877233222037950033330689843112576948",
                "0.0006794497604561647998377905891110713164818",
                "0.0005286372551487423400507679143654566618671",
                "0.0004112998995158266725084415935531164489333",
                "0.0003200072813953790688039146746460744883524",
                "0.0002489783222839342203686813426635725041051",
                "0.0001937151691705289358239430391652328042168",
                "0.0001507183536318243685998237032048288136842",
                "0.0001172651785768321175928904827833950298315",
                "0.00009123729749122294277525793429339102658516",
                "0.00007098656656493265303371822749614984627444",
                "0.00005523067402324092261037932649591363175376",
                "0.00004297193684583957618914024434161919278198",
                "0.00003343412229486188591619993893555790660303",
                "0.00002601329321041969484209701289485490347959",
                "0.00002023956417081485666006705388618586105326",
                "0.00001574734660455513017032161793798333472549",
                "0.00001225219854613625613434797116041650520787",
                "9.532812995923475765495144392712069106122e-6",
                "7.417004266777218502534347379163366066261e-6",
                "5.770804886286219834698210143578545095029e-6",
                "4.489982608506907646867509249907586554227e-6",
                "3.493440348409836731079066583001162419689e-6",
                "2.718081091936830702056389560828231840442e-6",
                "2.114812606239518573566855544276292969320e-6",
                "1.645438953571485387555113703528904100977e-6",
                "1.280241969527208545290506519998287032862e-6"
            };

            ddouble[] n256_expecteds = {
                "0.003921568627450980392156862745098039215686",
                "0.003051117661034307746525188025747734335975",
                "0.002373878653527086134968311978538795616518",
                "0.001846964282652330372553683192990382510356",
                "0.001437007054779904769019274664171689136083",
                "0.001118046133934354814355791427071380465646",
                "0.0008698832492684177381991194947472002135515",
                "0.0006768035543907719148274553926879476125917",
                "0.0005265804263777066949564625848774646669957",
                "0.0004097011756390342226277399829615826872878",
                "0.0003187646290996484215588975991393906730075",
                "0.0002480124345899088376330045171201055879308",
                "0.0001929644033739308085171395550296708949767",
                "0.0001501347967937983556429427773810998024144",
                "0.0001168115894011748561890634340152076959500",
                "0.00009088472937418440078723124645816754164852",
                "0.00007071252008813509679052215044414369736006",
                "0.00005501766095843326020467777928781925907842",
                "0.00004280636400955305256192942426428722119224",
                "0.00003330542400870604007439040881296663055609",
                "0.00002591325699228772008794338572029078326059",
                "0.00002016180661680237756481638160186914131686",
                "0.00001568690600838828932363895602377200026432",
                "0.00001220521825438973958907418498278218212155",
                "9.496295288983598307655672801805472458313e-6",
                "7.388619057099418143422244331493965120280e-6",
                "5.748741024379262817479862612683895242678e-6",
                "4.472832306602952056211232958283910635807e-6",
                "3.480109345551558238766990660110880351121e-6",
                "2.707718827160811925469378612790351873855e-6",
                "2.106757943533479191373524203718764708006e-6",
                "1.639177994845131470975882928585131462375e-6",
                "1.275375263318800668466921857336763619796e-6"
            };

            foreach ((int n, ddouble[] expecteds) in new (int, ddouble[])[] {
                (0, n0_expecteds), (1, n1_expecteds), (2, n2_expecteds), (3, n3_expecteds),
                (4, n4_expecteds), (8, n8_expecteds), (16, n16_expecteds), (32, n32_expecteds),
                (64, n64_expecteds), (128, n128_expecteds), (255, n255_expecteds), (256, n256_expecteds),
            }) {
                for ((int i, ddouble x) = (0, 0); i < expecteds.Length; i++, x += 1d / 4) {
                    ddouble expected = expecteds[i];

                    ddouble y = ddouble.En(n, x);
                    ddouble y_dec = ddouble.En(n, ddouble.BitDecrement(x));
                    ddouble y_inc = ddouble.En(n, ddouble.BitIncrement(x));

                    Console.WriteLine($"{n},{x}");
                    Console.WriteLine(y);

                    PrecisionAssert.AlmostEqual(expected, y, 1e-30d, $"{n},{x}");

                    if (x != 0) {
                        PrecisionAssert.AlmostEqual(expected, y_dec, 1e-30d, $"{n},{x} dec");
                        PrecisionAssert.AlmostEqual(expected, y_inc, 1e-30d, $"{n},{x} inc");
                    }
                }
            }

            PrecisionAssert.IsPositiveInfinity(ddouble.En(0, 0));
            PrecisionAssert.IsPositiveInfinity(ddouble.En(1, 0));

            PrecisionAssert.IsNaN(ddouble.En(0, ddouble.NaN));
            PrecisionAssert.IsNaN(ddouble.En(1, ddouble.NaN));
            PrecisionAssert.IsNaN(ddouble.En(2, ddouble.NaN));
            PrecisionAssert.IsNaN(ddouble.En(3, ddouble.NaN));

            PrecisionAssert.IsPlusZero(ddouble.En(0, ddouble.PositiveInfinity));
            PrecisionAssert.IsPlusZero(ddouble.En(1, ddouble.PositiveInfinity));
            PrecisionAssert.IsPlusZero(ddouble.En(2, ddouble.PositiveInfinity));
            PrecisionAssert.IsPlusZero(ddouble.En(3, ddouble.PositiveInfinity));

            PrecisionAssert.IsNaN(ddouble.En(0, -1));
            PrecisionAssert.IsNaN(ddouble.En(1, -1));
            PrecisionAssert.IsNaN(ddouble.En(2, -1));
            PrecisionAssert.IsNaN(ddouble.En(3, -1));
        }
    }
}
